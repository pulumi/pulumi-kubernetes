name: pvc
runtime: yaml
description: |
  Tests PVC with WaitForFirstConsumer (https://github.com/pulumi/pulumi-kubernetes/issues/895)

resources:
  ns:
    type: kubernetes:core/v1:Namespace

  storage:
    type: kubernetes:yaml/v2:ConfigFile
    properties:
      file: https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.28/deploy/local-path-storage.yaml

  provider:
    type: pulumi:providers:kubernetes
    properties:
      namespace: ${ns.metadata.name}

  pvc:
    type: kubernetes:core/v1:PersistentVolumeClaim
    properties:
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: local-path
        resources:
          requests:
            storage: 1Mi
    options:
      provider: ${provider}
      dependsOn:
        - ${storage}

  # Add a deployment to consume the PVC.
  deployment:
    type: kubernetes:apps/v1:Deployment
    properties:
      spec:
        replicas: 1
        selector:
          matchLabels:
            app: nginx
        template:
          metadata:
            labels:
              app: nginx
          spec:
            containers:
              - name: nginx
                image: nginx:stable-alpine3.17-slim
                volumeMounts:
                  - name: local
                    mountPath: /usr/share/nginx/html
            volumes:
              - name: local
                persistentVolumeClaim:
                  claimName: ${pvc.metadata.name}
    options:
      provider: ${provider}

outputs:
  status: ${pvc.status.phase}
